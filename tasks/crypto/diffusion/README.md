# Отборочный этап Кубка CTF России 2020

## Crypto | Diffusion

### Описание

> Здесь должен был быть таск на криптографию, но в последний момент что-то пошло не так.
> 
> Вы уже посмотрели в исходный код? Если честно, я не понимаю что там написано.
> 
> Несмотря на это, с его помощью кто-то смог совершить обмен ключами.
> 
> Думаю, вам непременно стоит заняться этой неразберихой.
> 
> _Подсказка: это таск на криптографию._

### Хинт

> В таске используется криптосистема XTR, но при её реализации были допущены ошибки. Попробуйте их поискать.

### Выдаваемые файлы

- [diffusion.sage](task/diffusion.sage)
- [output.txt](task/output.txt)

### Решение

Никакой неразберихи нет, в таске просто реализован [протокол Диффи-Хеллмана](https://ru.wikipedia.org/wiki/Протокол_Диффи_—_Хеллмана) с использованием [алгоритма XTR](https://ru.wikipedia.org/wiki/XTR_(алгоритм)). Имеется переписка двух участников, нам нужно найти общий секрет и расшифровать флаг.

Если разобраться в реализации, можно заметить, что нигде не используется параметр `q` (точнее, он вообще не определён), а секретные значения (в нашем случае `a` и `b`) берутся из интервала `(1, p)`. Это может означать две вещи:

- автор забыл добавить `q` в публичный ключ и неправильно генерирует секреты
- автор вообще не генерировал XTR-группу нужным образом, а просто взял случайный элемент в качестве генератора

Нас интересует второй случай. Зная, что порядок XTR-супергруппы равен `p^2 - p + 1`, попробуем найти порядок элемента `g`.

> Здесь и далее нам понадобится факторизовывать большие числа. Я буду использовать для этого утилиту [yafu](https://sourceforge.net/projects/yafu/). В таске параметры специально подобраны так, чтобы факторизация проходила достаточно быстро. Маленький хинт: чтобы sage быстро факторизовывал числа, для которых известно разложение, можно использовать функцию `pari.addprimes`.

Переберём все делители числа `p^2 - p + 1`, и для каждого делителя `d` будем вычислять `S(g, d)`, чтобы найти порядок `g`. Обнаружим, что `g` имеет очень маленький порядок — `7^2 * 7039399 * 329458369`, и как можно заметить, он достаточно гладкий. 

Используя `Trace()` и `Poly()` из описания алгоритма XTR, перейдём из XTR-группы в `GF(p^6)`, чтобы было удобнее считать дискретный логарифм. Так как порядок `g` гладкий, воспользуемся [алгоритмом Полига-Хеллмана](https://ru.wikipedia.org/wiki/Алгоритм_Полига_—_Хеллмана) для подсчёта дискретного логарифма.

После получения секрета найдём общий ключ и расшифруем флаг.

__Пример решения: [solver.sage](task/solver.sage)__

### Флаг

`ctfcup{n1c3_j0b!!!_1_h0p3_y0u_l1k3d_1t}`
